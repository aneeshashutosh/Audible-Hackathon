<html>
<head>
  <link rel="stylesheet" href="css/player.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
</head>
<body>
  <div id="message">Click mic to toggle listening</div>
  <div id="meter" class="icon-microphone"><span></span></div>
  <script>
    var audioCtx = new AudioContext;
    var url = 'mp3/EP100_Nightfall.mp3';
    var audio = new Audio(url);
    var processor = audioCtx.createScriptProcessor(2048, 1, 1);
    var meter = document.getElementById('meter');
    var source;
    audio.playbackRate = 1.0;
    audio.muted = true;


    audio.addEventListener('canplaythrough', function(){
      source = audioCtx.createMediaElementSource(audio);
      source.connect(processor);
      source.connect(audioCtx.destination);
      processor.connect(audioCtx.destination);
      audio.play();
    }, false);

    // loop through PCM data and calculate average
    // volume for a given 2048 sample buffer
    processor.onaudioprocess = function(evt){
      var input = evt.inputBuffer.getChannelData(0)
        , len = input.length
        , total = i = 0
        , rms;
      while ( i < len ) total += Math.abs( input[i++] );
      rms = Math.sqrt( total / len );
      console.log(( rms * 100 ));
    };
  </script>
</body>
</html>
